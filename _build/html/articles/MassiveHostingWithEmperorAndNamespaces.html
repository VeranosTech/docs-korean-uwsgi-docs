

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="ko" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="ko" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Massive &#34;secure&#34; Hosting with the Emperor and Linux Namespaces, AKA &#34;Improving unbit.it and pythonanywhere.com&#34; &mdash; uWSGI 2.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="색인" href="../genindex.html" />
    <link rel="search" title="검색" href="../search.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> uWSGI
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../WSGIquickstart.html">Quickstart for Python/WSGI applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PSGIquickstart.html">Quickstart for perl/PSGI applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RackQuickstart.html">Quickstart for ruby/Rack applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Snippets.html">Snippets</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Download.html">Getting uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Install.html">Installing uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BuildSystem.html">The uWSGI build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Management.html">Managing the uWSGI server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LanguagesAndPlatforms.html">Supported languages and platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SupportedPlatforms.html">Supported Platforms/Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WebServers.html">Web server integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html">Frequently Asked Questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ThingsToKnow.html">Things to know (best practices and &quot;issues&quot;) READ IT !!!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Configuration.html">Configuring uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FallbackConfig.html">Fallback configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ConfigLogic.html">Configuration logic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Options.html">uWSGI Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CustomOptions.html">Defining new options for your instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ParsingOrder.html">How uWSGI parses config files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Vars.html">uwsgi protocol magic variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Protocol.html">The uwsgi Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AttachingDaemons.html">Managing external daemons/services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MasterFIFO.html">The Master FIFO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Inetd.html">Socket activation with inetd/xinetd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Upstart.html">Running uWSGI via Upstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Systemd.html">Systemd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Circus.html">Running uWSGI instances with Circus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Embed.html">Embedding an application in uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LogFormat.html">Formatting uWSGI requests logs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LogEncoders.html">Log encoders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Hooks.html">Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WorkerOverride.html">Overriding Workers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ThirdPartyPlugins.html">uWSGI third party plugins</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/CachingCookbook.html">The uWSGI Caching Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/Django_and_nginx.html">Setting up Django and your web server with uWSGI and nginx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/dreamhost.html">Running uWSGI on Dreamhost shared hosting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/heroku_python.html">Running python webapps on Heroku with uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/heroku_ruby.html">Running Ruby/Rack webapps on Heroku with uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/ReliableFuse.html">Reliably use FUSE filesystems for uWSGI vassals (with Linux)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/DynamicProxying.html">Build a dynamic proxy using RPC and internal routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/GraphiteAndMetrics.html">Setting up Graphite on Ubuntu using the Metrics subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="SerializingAccept.html">Serializing accept(), AKA Thundering Herd, AKA the Zeeg Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="TheArtOfGracefulReloading.html">The Art of Graceful Reloading</a></li>
<li class="toctree-l1"><a class="reference internal" href="FunWithPerlEyetoyRaspberrypi.html">Fun with Perl, Eyetoy and RaspberryPi</a></li>
<li class="toctree-l1"><a class="reference internal" href="OffloadingWebsocketsAndSSE.html">Offloading Websockets and Server-Sent Events AKA &quot;Combine them with Django safely&quot;</a></li>
<li class="toctree-l1"><a class="reference internal" href="WSGIEnvBehaviour.html">WSGI env behaviour policies</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../AlarmSubsystem.html">The uWSGI alarm subsystem (from 1.3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Caching.html">The uWSGI caching framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WebCaching.html">WebCaching framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Cron.html">The uWSGI cron-like interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Fastrouter.html">The uWSGI FastRouter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../InternalRouting.html">uWSGI internal routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Legion.html">The uWSGI Legion subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Locks.html">Locks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Mules.html">uWSGI Mules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OffloadSubsystem.html">The uWSGI offloading subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Queue.html">The uWSGI queue framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RPC.html">uWSGI RPC Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SharedArea.html">SharedArea -- share memory pages between uWSGI components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Signals.html">The uWSGI Signal Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Spooler.html">The uWSGI Spooler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SubscriptionServer.html">uWSGI Subscription Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../StaticFiles.html">Serving static files with uWSGI (updated to 1.9)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SNI.html">SNI - Server Name Identification (virtual hosting for SSL nodes)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GeoIP.html">The GeoIP plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Transformations.html">uWSGI Transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WebSockets.html">WebSocket support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Metrics.html">The Metrics subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chunked.html">The Chunked input API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Cheaper.html">The uWSGI cheaper subsystem -- adaptive process spawning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Emperor.html">The uWSGI Emperor -- multi-app deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Broodlord.html">Auto-scaling with Broodlord mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Zerg.html">Zerg mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../DynamicApps.html">Adding applications dynamically</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SSLScaling.html">Scaling SSL connections (uWSGI 1.9)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Capabilities.html">Setting POSIX Capabilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Cgroups.html">Running uWSGI in a Linux CGroup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../KSM.html">Using Linux KSM in uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Namespaces.html">Jailing your apps using Linux Namespaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Namespaces.html#the-old-way-the-namespace-option">The old way: the --namespace option</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FreeBSDJails.html">FreeBSD Jails</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ForkptyRouter.html">The Forkpty Router</a></li>
<li class="toctree-l1"><a class="reference internal" href="../TunTapRouter.html">The TunTap Router</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Nagios.html">Monitoring uWSGI with Nagios</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SNMP.html">The embedded SNMP server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PushingStats.html">Pushing statistics (from 1.4)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Carbon.html">Integration with Graphite/Carbon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../StatsServer.html">The uWSGI Stats Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Metrics.html">The Metrics subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Async.html">uWSGI asynchronous/non-blocking modes (updated to uWSGI 1.9)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Gevent.html">The Gevent loop engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tornado.html">The Tornado loop engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uGreen.html">uGreen -- uWSGI Green Threads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../asyncio.html">The asyncio loop engine (CPython &gt;= 3.4, uWSGI &gt;= 2.0.4)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Apache.html">Apache support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Cherokee.html">Cherokee support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HTTP.html">Native HTTP support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HTTPS.html">HTTPS 지원 (1.3 버전부터)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SPDY.html">The SPDY router (uWSGI 1.9)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lighttpd.html">Lighttpd support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Mongrel2.html">Attaching uWSGI to Mongrel2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Nginx.html">Nginx support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OpenBSDhttpd.html">Using OpenBSD httpd as proxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OpenBSDhttpd.html#notes">Notes</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Python.html">Python support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PyPy.html">The PyPy plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PHP.html">Running PHP scripts in uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Perl.html">uWSGI Perl support (PSGI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Ruby.html">Ruby support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lua.html">Using Lua/WSAPI with uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../JVM.html">JVM in the uWSGI server (updated to 1.9)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Mono.html">The Mono ASP.NET plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CGI.html">Running CGI scripts on uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCCGO.html">The GCCGO plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Symcall.html">The Symcall plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../XSLT.html">The XSLT plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SSI.html">SSI (Server Side Includes) plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../V8.html">uWSGI V8 support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GridFS.html">The GridFS plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GlusterFS.html">The GlusterFS plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Rados.html">The RADOS plugin</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Pty.html">The Pty plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SPNEGO.html">SPNEGO authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LDAP.html">Configuring uWSGI with LDAP</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Erlang.html">Integrating uWSGI with Erlang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ManagementFlag.html">Management Flags</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Go.html">uWSGI Go support (1.4 only)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.18.html">uWSGI 2.0.18</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.17.1.html">uWSGI 2.0.17.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.17.html">uWSGI 2.0.17</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.16.html">uWSGI 2.0.16</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.15.html">uWSGI 2.0.15</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.14.html">uWSGI 2.0.14</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.13.1.html">uWSGI 2.0.13.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.13.html">uWSGI 2.0.13</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.12.html">uWSGI 2.0.12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.11.2.html">uWSGI 2.0.11.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.11.1.html">uWSGI 2.0.11.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.11.html">uWSGI 2.0.11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.10.html">uWSGI 2.0.10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.9.html">uWSGI 2.0.9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.8.html">uWSGI 2.0.8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.7.html">uWSGI 2.0.7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.6.html">uWSGI 2.0.6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.5.html">uWSGI 2.0.5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.4.html">uWSGI 2.0.4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.3.html">uWSGI 2.0.3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.2.html">uWSGI 2.0.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.1.html">uWSGI 2.0.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.html">uWSGI 2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.21.html">uWSGI 1.9.21</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.20.html">uWSGI 1.9.20</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.19.html">uWSGI 1.9.19</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.18.html">uWSGI 1.9.18</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.17.html">uWSGI 1.9.17</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.16.html">uWSGI 1.9.16</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.15.html">uWSGI 1.9.15</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.14.html">uWSGI 1.9.14</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.13.html">uWSGI 1.9.13</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.12.html">uWSGI 1.9.12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.11.html">uWSGI 1.9.11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.10.html">uWSGI 1.9.10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.9.html">uWSGI 1.9.9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.8.html">uWSGI 1.9.8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.7.html">uWSGI 1.9.7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.6.html">uWSGI 1.9.6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.5.html">uWSGI 1.9.5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.4.html">uWSGI 1.9.4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.3.html">uWSGI 1.9.3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.2.html">uWSGI 1.9.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.1.html">uWSGI 1.9.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.html">uWSGI 1.9</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">uWSGI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Massive &quot;secure&quot; Hosting with the Emperor and Linux Namespaces, AKA &quot;Improving unbit.it and pythonanywhere.com&quot;</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/articles/MassiveHostingWithEmperorAndNamespaces.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="massive-secure-hosting-with-the-emperor-and-linux-namespaces-aka-improving-unbit-it-and-pythonanywhere-com">
<h1>Massive &quot;secure&quot; Hosting with the Emperor and Linux Namespaces, AKA &quot;Improving unbit.it and pythonanywhere.com&quot;<a class="headerlink" href="#massive-secure-hosting-with-the-emperor-and-linux-namespaces-aka-improving-unbit-it-and-pythonanywhere-com" title="제목 주소">¶</a></h1>
<p>Author: Roberto De Ioris</p>
<p><strong>* WORK IN PROGRESS *</strong></p>
<div class="section" id="disclaimer">
<h2>Disclaimer<a class="headerlink" href="#disclaimer" title="제목 주소">¶</a></h2>
<p>In the following intro i will mention two companies: Unbit and pythonanywhere.com. I work with both (effectively i own the first one :P).</p>
<p>If you think i am making advertising to both, well you are right.</p>
</div>
<div class="section" id="intro">
<h2>Intro<a class="headerlink" href="#intro" title="제목 주소">¶</a></h2>
<p>Since 2005 i work as chief sysadmin in the italian ISP Unbit (<a class="reference external" href="http://unbit.it">http://unbit.it</a>) and as a consultant for various hosting company worldwide.</p>
<p>Unbit is a developer-oriented service, we allow hosting basically anything you want without forcing you to a VPS, simply abusing Linux kernel facilities (it is very similar to what currently Heroku
does but about 5 years before Heroku existed ;)</p>
<p>In 2009 we started the uWSGI project, initially as a WSGI server, then we slowly realized that its paradigms could be applied to all our infrastructure, so now it is becoming
a sort of &quot;hosting platform&quot; for various languages. We plan to use only uWSGI for the whole Unbit hosting stack by 2014.</p>
<p>Before you get excited, Unbit accepts only Italian customers (we are not racists, it is a policy for avoiding legal problems with the other hosting companies we work with) and our prices
are quite high as we do not make any kind of over-selling (and more important we do not give free-accounts ;)</p>
<p>In more than 8 years me and my co-workers experienced thousands of problems (yes, if you want to enter the internet services market be prepared to invest the vast majority of your time
solving problems created by users without the minimal respect for you as a person ;) so, what you see in the whole uWSGI project is the result of this years
of headaches and non-sleeping nights (and insults by customers)</p>
<p>During summer 2013 i worked a bit with the pythonanywhere.com guys (mainly with Harry Percival).</p>
<p>They heavily use uWSGI features for their service, so they helped popping-up new ideas and solutions in my mind.</p>
<p>In uWSGI 1.9.15 lot of new patches for advanced Linux namespaces usage have been merged, thanks to the collaboration with pythonanywhere.com guys.</p>
<p>Based on the experiences of the two companies, this article will show one of the approaches you can follow to build your service for hosting unreliable webapps (yes, even if you have the largest collection of pacifist customers, they have to be considered 'unreliable' and 'evil', otherwise you are not a good sysadmin).</p>
<p>It is not a step-by-step tutorial, but some kind of cookbook to give you some basis for improving and adapting the concepts for your needs.</p>
</div>
<div class="section" id="what-we-want-to-allow-to-our-users">
<h2>What we want to allow to our users<a class="headerlink" href="#what-we-want-to-allow-to-our-users" title="제목 주소">¶</a></h2>
<ul class="simple">
<li>deploy WSGI,PSGI and RACK applications (no CGI and php, albeit technically possible, if you think you can make any kind of money with php hosting you should start finding a second job)</li>
<li>run cron scripts</li>
<li>run private services (redis, beanstalkd, memcached...)</li>
<li>applications can connect to the internet</li>
<li>multiple domain names can map to the same instance</li>
</ul>
</div>
<div class="section" id="and-what-we-want-to-forbid">
<h2>...and what we want to forbid<a class="headerlink" href="#and-what-we-want-to-forbid" title="제목 주소">¶</a></h2>
<ul class="simple">
<li>users cannot see the processes of the other accounts in the machine. Their init process has to be the uWSGI master</li>
<li>users cannot see the files of the other accounts in the machine</li>
<li>users cannot connect to private services (memcached, redis...) of the other accounts in the machine</li>
<li>users cannot read/write ipc semaphores, shared memory and message queues of the other accounts in the machine</li>
<li>users cannot allocate more memory than the amount they paid for</li>
<li>users cannot use more cpu power than the amount they paid for</li>
</ul>
</div>
<div class="section" id="the-operating-system">
<h2>The Operating System<a class="headerlink" href="#the-operating-system" title="제목 주소">¶</a></h2>
</div>
<div class="section" id="the-webserver">
<h2>The Webserver<a class="headerlink" href="#the-webserver" title="제목 주소">¶</a></h2>
<p>As we do not need to worry about php and the abuse of .htaccess files, we can choose any server we want.</p>
<p>We prefer nginx (even if we [Unbit] are slowly moving to the uWSGI http/https/spdy router as we only need a minimal proxy with dynamic routing, but for anything more complex nginx is the way to go), but you can use whatever you like.</p>
</div>
<div class="section" id="the-control-panel">
<h2>The &quot;control panel&quot;<a class="headerlink" href="#the-control-panel" title="제목 주소">¶</a></h2>
<p>This is the thing you need to develop, the more your panel is usable and powerful the more your users will be happy.</p>
<p>Your control panel is probably the thing will make your hosting company successful.</p>
<p>The objective of your control panel is generating &quot;vassal files&quot; (see below). Vassal files can be .ini, xml, yaml and json (unless you have particular reasons to use other formats).</p>
<p>The vassal file contains the whole structure of a customer micro-system. As soon as a vassal file is created it will be deployed (and when it is changed it will be reloaded)</p>
</div>
<div class="section" id="uwsgi-language-plugins">
<h2>uWSGI 'language' plugins<a class="headerlink" href="#uwsgi-language-plugins" title="제목 주소">¶</a></h2>
<p>We want to support multiple kind of applications. The better approach will be having a single uWSGI binary and a series of 'language plugins' (one for each language you want to support).</p>
<p>You can support multiple versions of the same language. Just build the corresponding plugin.</p>
<p>In Unbit we make an extremely modular uWSGi distribution (basically all is a plugin). This is required as we account any MB of memory
so we allow users to enable only the required features to gain much memory as possible.</p>
<p>If you are still not a black-belt in uWSGI mastering, i suggest you to start with the included 'nolang' build profile.</p>
<p>It will build a standard uwsgi binary without any language builtin.</p>
<p>...</p>
</div>
<div class="section" id="lazy-apps-vs-prefork">
<h2>Lazy apps VS prefork<a class="headerlink" href="#lazy-apps-vs-prefork" title="제목 주소">¶</a></h2>
<p>One of the controversial design choices of uWSGI is &quot;preforking by default&quot;.</p>
<p>It means your app is loaded on startup and then fork() is called for each worker.</p>
<p>While this is the common approach in the UNIX world and it is an expected behaviour for a Perl developer
(that is historically more near to the UNIX world) it is totally unknown and unexpected by a Python (and maybe Ruby) one.</p>
<p>So one of the choices you need to make when building a uWSGI-based service is how to manage the fork() behaviour.</p>
<p>If you are unsure let me tell you one thing: with preforking behaviour you will make some user very happy, and lot of users
completely lost. With --lazy-apps you will have all of your users totally unconcerned. Trust me, few happy users cannot make you happy too when you have angry customers too.</p>
<p>So, uWSGI default fork() behaviour is generally wrong for massive hosting, so add --lazy-apps and eventually give the advanced users the freedom to change it when needed.</p>
</div>
<div class="section" id="the-filesystem-layout">
<h2>The filesystem layout<a class="headerlink" href="#the-filesystem-layout" title="제목 주소">¶</a></h2>
<p>Distro upgrades are always a bloodbath. It is a pretty optimistic analysis. trust me.</p>
<p>But &quot;tempus fugit&quot; so sooner or later one of your customer will start asking for a more recent packages set...</p>
<p>You can upgrade, but you will automatically place the vast majority of your customers in berserk mode, as very probably their apps
will no more work.</p>
<p>A solution for making everyone happy is having different distribution in your system (yes, it sounds silly, but please continue reading).</p>
<p>Debbotstrap is a great tool. Let's create under the /distros directory our set of distributions:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>debootstrap lucid /distros/lucid
debootstrap etch /distros/etch
debootstrap precise /distros/precise
debootstrap saucy /distros/saucy
...
</pre></div>
</div>
<p>Each user will be able to choose (and change) its distro, as thanks to our setup (see below) its root filesystem will be a readonly mount
of one of the available distros.</p>
<p>The final layout will be:</p>
<ul class="simple">
<li>/ (rootfs, mapped readonly to one of the dir in /distros)</li>
<li>/proc (needed for showing processes and getting system informations)</li>
<li>/tmp (each user should have a dedicated /tmp)</li>
<li>/dev (should contain at least zero and null, but can be a bind mount to the system /dev too)</li>
<li>/dev/pts (required for pseudoterminals, shared by all vassals [til linux pts namespace will be released])</li>
<li>/var/run (all of the sockets will be bound here, and symlinked by the main rootfs for nginx and ssh access)</li>
<li>/opt (this could be a bind mount shared by all of the users containing distribution independent files)</li>
</ul>
</div>
<div class="section" id="linux-namespaces">
<h2>Linux namespaces<a class="headerlink" href="#linux-namespaces" title="제목 주소">¶</a></h2>
<p>This is the first step to limit users.</p>
<p>For this setup we will use 5 namespaces: filesystem, sysv ipc, uts, networking and pid</p>
<div class="section" id="filesystem-fs">
<h3>filesystem (fs)<a class="headerlink" href="#filesystem-fs" title="제목 주소">¶</a></h3>
<p>this allows changing the filesystems layout (mountpoints).</p>
<p>Instead of chroot() in each vassal, we will use the --pivot-root option (it is linux specific) that combined with
mount namespace allows fine-grained configuration of the filesystem layout</p>
</div>
<div class="section" id="sysv-ipc-ipc">
<h3>sysv ipc (ipc)<a class="headerlink" href="#sysv-ipc-ipc" title="제목 주소">¶</a></h3>
<p>sysv ipc exposes 3 primitives: semaphores, shared memory and message queues.</p>
<p>unsharing it creates a dedicated set of this 3 features</p>
</div>
<div class="section" id="uts-uts">
<h3>uts (uts)<a class="headerlink" href="#uts-uts" title="제목 주소">¶</a></h3>
<p>this namespace allows you to have a dedicated hostname</p>
</div>
<div class="section" id="networking-net">
<h3>networking (net)<a class="headerlink" href="#networking-net" title="제목 주소">¶</a></h3>
<p>when you unshare for the main network namespace, you will lose access to interface addresses. A new loopback will be allocated.</p>
</div>
<div class="section" id="processes-pid">
<h3>processes (pid)<a class="headerlink" href="#processes-pid" title="제목 주소">¶</a></h3>
<p>this namespace allows you to hide the user the processes not being part of the user namspace itself.</p>
<p>The uWSGI master process will be the pid 1 for the user.</p>
</div>
<div class="section" id="namespacing-the-emperor">
<h3>Namespacing the Emperor<a class="headerlink" href="#namespacing-the-emperor" title="제목 주소">¶</a></h3>
<p>The --emperor-use-clone option allows the Emperor to directly spawn vassals in a new namespace.</p>
<p>Our config will be something like:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">emperor</span> <span class="o">=</span> <span class="s">/etc/uwsgi/vassals</span>
<span class="na">emperor-user-clone</span> <span class="o">=</span> <span class="s">fs,ipc,uts,net,pid</span>
</pre></div>
</div>
<p>while each vassal will be</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; set the hostname</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">hostname foobar</span>
<span class="c1">; bring up loopback</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">ifconfig lo up</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="linux-cgroups">
<h2>Linux cgroups<a class="headerlink" href="#linux-cgroups" title="제목 주소">¶</a></h2>
</div>
<div class="section" id="uwsgi-emperor-and-vassals">
<h2>uWSGI Emperor and vassals<a class="headerlink" href="#uwsgi-emperor-and-vassals" title="제목 주소">¶</a></h2>
</div>
<div class="section" id="networking">
<h2>Networking<a class="headerlink" href="#networking" title="제목 주소">¶</a></h2>
<p>This is probably the most complex part. The &quot;ortodox&quot; way to give networking to a jailed setup is using veth or macvlan.</p>
<p>The first one is a &quot;network pipe&quot; composed by two virtual interfaces. After the namespace is created you can move one of the end of the pipe to the namespace.</p>
<p>Macvlan, instead works by assigning an additional mac address to the physical interface.</p>
<p>Both solutions are great for VPS-like setups, but here we need networking only to connect to external services (inbound connections are managed by the http proxy).</p>
<p>Both veth and macvlan approaches are hard to manage correctly, and while in 1.9.15 we introduced lot of features to simplify the required steps, in 1.9.16 we decided
to create an ad-hoc solution based on tuntap devices.</p>
<p>Basically for each vassal we create a tun device (it is a virtuale network interface manageable via user space) connected (via unix sockets) to another tun device in the main namespace.</p>
<p>The tuntap-router is a software-based ip router, it mainly get packets fro ma tuntap device and forward them to a unix socket (and the opposite).</p>
<p>This approach simplify the whole setup extremely, and, as a killer feature an ultra simpel firewall is embedded in the process to configure internal rules.</p>
<p>The tuntap router should run in the Emperor (it is a uWSGI gateway so this time we need the master process):</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">emperor</span> <span class="o">=</span> <span class="s">/etc/uwsgi/vassals</span>
<span class="na">emperor-user-clone</span> <span class="o">=</span> <span class="s">fs,ipc,uts,net,pid</span>
<span class="na">master</span> <span class="o">=</span> <span class="s">true</span>
<span class="c1">; create the tun interface &#39;emperor0&#39; reachable by /var/run/tuntap.socket</span>
<span class="na">tuntap-router</span> <span class="o">=</span> <span class="s">emperor0 /var/run/tuntap.socket</span>
<span class="c1">; give an internal ip address to &#39;emperor0&#39;</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">ifconfig emperor0 192.168.0.1 netmask 255.255.255.0</span>
<span class="c1">; configure NAT for vassals</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">iptables -t nat -F</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">iptables -t nat -A POSTROUTING -o eth0 -s 192.168.0.0/24 -j MASQUERADE</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span>

<span class="c1">; configure the internal firewall to disallow communication between vassals</span>
<span class="na">tuntap-router-firewall-out</span> <span class="o">=</span> <span class="s">allow 192.168.0.0/24 192.168.0.1</span>
<span class="na">tuntap-router-firewall-out</span> <span class="o">=</span> <span class="s">deny 192.168.0.0/24 192.168.0.0/24</span>
<span class="na">tuntap-router-firewall-out</span> <span class="o">=</span> <span class="s">allow 192.168.0.0/24 0.0.0.0</span>
<span class="c1">; we need this rule as default policy is &#39;allow&#39;</span>
<span class="na">tuntap-router-firewall-out</span> <span class="o">=</span> <span class="s">deny</span>
<span class="na">tuntap-router-firewall-in</span> <span class="o">=</span> <span class="s">allow 192.168.0.1 192.168.0.0/24</span>
<span class="na">tuntap-router-firewall-in</span> <span class="o">=</span> <span class="s">deny 192.168.0.0/24 192.168.0.0/24</span>
<span class="na">tuntap-router-firewall-in</span> <span class="o">=</span> <span class="s">allow 0.0.0.0 192.168.0.0/24</span>
<span class="c1">; we need this rule as default policy is &#39;allow&#39;</span>
<span class="na">tuntap-router-firewall-in</span> <span class="o">=</span> <span class="s">deny</span>
</pre></div>
</div>
<p>and a vassal</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">master</span> <span class="o">=</span> <span class="s">true</span>
<span class="c1">; set the hostname</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">hostname foobar</span>
<span class="c1">; bring up loopback</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">ifconfig lo up</span>
<span class="c1">; bring up the tuntap device and connect to the emperor</span>
<span class="na">tuntap-device</span> <span class="o">=</span> <span class="s">uwsgi0 /var/run/tuntap.socket</span>
<span class="c1">; configure the &#39;uwsgi0&#39; interface</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">ifconfig uwsgi0 192.168.0.2 netmask 255.255.255.0</span>
<span class="c1">; use the tuntap router as default gw</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">route add default gw 192.168.0.1</span>
<span class="na">...</span>
</pre></div>
</div>
</div>
<div class="section" id="cron">
<h2>Cron<a class="headerlink" href="#cron" title="제목 주소">¶</a></h2>
<p>Cron tasks are added to the vassal file, the syntax is a bit different from classic crontabs as intead of * and the , we only use numbers
(yes it is a bit less versatile than classic cron, but uWSGI config files allows for cycle and other constructs)</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; run at 23:59 every day</span>
<span class="na">cron</span> <span class="o">=</span> <span class="s">59 23 -1 -1 -1 myscript arg1</span>
<span class="c1">; run every five minutes on saturday</span>
<span class="na">cron</span> <span class="o">=</span> <span class="s">-5 -1 -1 -1 6</span>
</pre></div>
</div>
</div>
<div class="section" id="static-file-serving">
<h2>Static file serving<a class="headerlink" href="#static-file-serving" title="제목 주소">¶</a></h2>
</div>
<div class="section" id="additional-daemons">
<h2>Additional daemons<a class="headerlink" href="#additional-daemons" title="제목 주소">¶</a></h2>
</div>
<div class="section" id="ssh">
<h2>SSH<a class="headerlink" href="#ssh" title="제목 주소">¶</a></h2>
<p>Managing ssh could be really tricky with namespace setups. The Linux syscall &quot;setns&quot; allows &quot;attaching&quot; to an already running namespace.</p>
<p>It generally works, but i will now tell you a technical reason why i do not want to use it for my services: i do not like it. period.</p>
<p>We have already seen unix sockets works very well as a communication channel between namespaces, why not use them to &quot;enter&quot; an already running namespace ?</p>
<p>If you work as a unix sysadmin, you cannot ignore pseudoterminals (or terminals in general). It is one of the oldest (and rawest) api of the unix world, by the work by ages. And they works great.</p>
<p>The uWSGI distribution come with 2 pty-related plugin: pty and forkptyrouter.</p>
<p>The first one simply attach a single pseudoterminal to your workers and bind to a network address. Connecting to this address give access
to the pseudoterminal. This trick allows for advanced techniques like shared debugging. The pty plugin exposes the client part too, so you can use the uwsgi binary itself to connect to this pty.</p>
<p>How this can be useful for our ssh access ? It is not.</p>
<p>What we need now is the forkptyrouter (or forkpty-router for better readability). It works very similar to the pty server with the difference
it generate a new pty for each connection. Exacly like ssh does.</p>
<p>The forkpty-router run into the namespace, so any process attached to it will effectively run in the namespace itself.</p>
<p>You should now see the point: our customers login via ssh as non-namespaced account but instead giving them the default shell we force them to connect
to the pty-router.</p>
<p>The &quot;downside&quot; of this approach is that we need two pty for each ssh peer (one for client -&gt; ssh and the other for ssh -&gt; namespace).</p>
<p>To force the ssh server to run a specific command, use the ForceCommand directive in the sshd_config</p>
</div>
<div class="section" id="bonus-ksm">
<h2>Bonus: KSM<a class="headerlink" href="#bonus-ksm" title="제목 주소">¶</a></h2>
</div>
<div class="section" id="what-is-missing">
<h2>What is missing<a class="headerlink" href="#what-is-missing" title="제목 주소">¶</a></h2>
<ul class="simple">
<li>Accounting network usage</li>
<li>Scaling to multiple machines</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2012-2016, uWSGI.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'2.0',
            LANGUAGE:'ko',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>