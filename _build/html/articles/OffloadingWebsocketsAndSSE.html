

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="ko" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="ko" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Offloading Websockets and Server-Sent Events AKA &#34;Combine them with Django safely&#34; &mdash; uWSGI 2.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="색인" href="../genindex.html" />
    <link rel="search" title="검색" href="../search.html" />
    <link rel="next" title="WSGI env behaviour policies" href="WSGIEnvBehaviour.html" />
    <link rel="prev" title="Fun with Perl, Eyetoy and RaspberryPi" href="FunWithPerlEyetoyRaspberrypi.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> uWSGI
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../WSGIquickstart.html">Quickstart for Python/WSGI applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PSGIquickstart.html">Quickstart for perl/PSGI applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RackQuickstart.html">Quickstart for ruby/Rack applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Snippets.html">Snippets</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Download.html">Getting uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Install.html">Installing uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BuildSystem.html">The uWSGI build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Management.html">Managing the uWSGI server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LanguagesAndPlatforms.html">Supported languages and platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SupportedPlatforms.html">Supported Platforms/Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WebServers.html">Web server integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html">Frequently Asked Questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ThingsToKnow.html">Things to know (best practices and &quot;issues&quot;) READ IT !!!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Configuration.html">Configuring uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FallbackConfig.html">Fallback configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ConfigLogic.html">Configuration logic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Options.html">uWSGI Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CustomOptions.html">Defining new options for your instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ParsingOrder.html">How uWSGI parses config files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Vars.html">uwsgi protocol magic variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Protocol.html">The uwsgi Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AttachingDaemons.html">Managing external daemons/services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MasterFIFO.html">The Master FIFO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Inetd.html">Socket activation with inetd/xinetd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Upstart.html">Running uWSGI via Upstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Systemd.html">Systemd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Circus.html">Running uWSGI instances with Circus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Embed.html">Embedding an application in uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LogFormat.html">Formatting uWSGI requests logs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LogEncoders.html">Log encoders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Hooks.html">Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WorkerOverride.html">Overriding Workers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ThirdPartyPlugins.html">uWSGI third party plugins</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/CachingCookbook.html">The uWSGI Caching Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/Django_and_nginx.html">Setting up Django and your web server with uWSGI and nginx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/dreamhost.html">Running uWSGI on Dreamhost shared hosting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/heroku_python.html">Running python webapps on Heroku with uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/heroku_ruby.html">Running Ruby/Rack webapps on Heroku with uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/ReliableFuse.html">Reliably use FUSE filesystems for uWSGI vassals (with Linux)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/DynamicProxying.html">Build a dynamic proxy using RPC and internal routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/GraphiteAndMetrics.html">Setting up Graphite on Ubuntu using the Metrics subsystem</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="SerializingAccept.html">Serializing accept(), AKA Thundering Herd, AKA the Zeeg Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="TheArtOfGracefulReloading.html">The Art of Graceful Reloading</a></li>
<li class="toctree-l1"><a class="reference internal" href="FunWithPerlEyetoyRaspberrypi.html">Fun with Perl, Eyetoy and RaspberryPi</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Offloading Websockets and Server-Sent Events AKA &quot;Combine them with Django safely&quot;</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#disclaimer">Disclaimer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#uwsgi-offloading">uWSGI offloading</a></li>
<li class="toctree-l2"><a class="reference internal" href="#our-sse-app">Our SSE app</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-boring-html-javascript">The (boring) HTML/Javascript</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-django-view">The Django view</a></li>
<li class="toctree-l2"><a class="reference internal" href="#let-s-offload-the-sse-transaction">Let's offload the SSE transaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#simplifying-things-using-the-uwsgi-api-uwsgi-2-0-3">Simplifying things using the uwsgi api (&gt;= uWSGI 2.0.3)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-about-websockets">What about Websockets ?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-redis-or-uwsgi-caching-framework">Using redis or uWSGI caching framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="#common-pitfalls">Common pitfalls</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="WSGIEnvBehaviour.html">WSGI env behaviour policies</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../AlarmSubsystem.html">The uWSGI alarm subsystem (from 1.3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Caching.html">The uWSGI caching framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WebCaching.html">WebCaching framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Cron.html">The uWSGI cron-like interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Fastrouter.html">The uWSGI FastRouter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../InternalRouting.html">uWSGI internal routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Legion.html">The uWSGI Legion subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Locks.html">Locks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Mules.html">uWSGI Mules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OffloadSubsystem.html">The uWSGI offloading subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Queue.html">The uWSGI queue framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RPC.html">uWSGI RPC Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SharedArea.html">SharedArea -- share memory pages between uWSGI components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Signals.html">The uWSGI Signal Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Spooler.html">The uWSGI Spooler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SubscriptionServer.html">uWSGI Subscription Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../StaticFiles.html">Serving static files with uWSGI (updated to 1.9)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SNI.html">SNI - Server Name Identification (virtual hosting for SSL nodes)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GeoIP.html">The GeoIP plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Transformations.html">uWSGI Transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WebSockets.html">WebSocket support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Metrics.html">The Metrics subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chunked.html">The Chunked input API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Cheaper.html">The uWSGI cheaper subsystem -- adaptive process spawning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Emperor.html">The uWSGI Emperor -- multi-app deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Broodlord.html">Auto-scaling with Broodlord mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Zerg.html">Zerg mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../DynamicApps.html">Adding applications dynamically</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SSLScaling.html">Scaling SSL connections (uWSGI 1.9)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Capabilities.html">Setting POSIX Capabilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Cgroups.html">Running uWSGI in a Linux CGroup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../KSM.html">Using Linux KSM in uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Namespaces.html">Jailing your apps using Linux Namespaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Namespaces.html#the-old-way-the-namespace-option">The old way: the --namespace option</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FreeBSDJails.html">FreeBSD Jails</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ForkptyRouter.html">The Forkpty Router</a></li>
<li class="toctree-l1"><a class="reference internal" href="../TunTapRouter.html">The TunTap Router</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Nagios.html">Monitoring uWSGI with Nagios</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SNMP.html">The embedded SNMP server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PushingStats.html">Pushing statistics (from 1.4)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Carbon.html">Integration with Graphite/Carbon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../StatsServer.html">The uWSGI Stats Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Metrics.html">The Metrics subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Async.html">uWSGI asynchronous/non-blocking modes (updated to uWSGI 1.9)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Gevent.html">The Gevent loop engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tornado.html">The Tornado loop engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uGreen.html">uGreen -- uWSGI Green Threads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../asyncio.html">The asyncio loop engine (CPython &gt;= 3.4, uWSGI &gt;= 2.0.4)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Apache.html">Apache support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Cherokee.html">Cherokee support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HTTP.html">Native HTTP support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HTTPS.html">HTTPS 지원 (1.3 버전부터)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SPDY.html">The SPDY router (uWSGI 1.9)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lighttpd.html">Lighttpd support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Mongrel2.html">Attaching uWSGI to Mongrel2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Nginx.html">Nginx support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OpenBSDhttpd.html">Using OpenBSD httpd as proxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OpenBSDhttpd.html#notes">Notes</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Python.html">Python support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PyPy.html">The PyPy plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PHP.html">Running PHP scripts in uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Perl.html">uWSGI Perl support (PSGI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Ruby.html">Ruby support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lua.html">Using Lua/WSAPI with uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../JVM.html">JVM in the uWSGI server (updated to 1.9)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Mono.html">The Mono ASP.NET plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CGI.html">Running CGI scripts on uWSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCCGO.html">The GCCGO plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Symcall.html">The Symcall plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../XSLT.html">The XSLT plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SSI.html">SSI (Server Side Includes) plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../V8.html">uWSGI V8 support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GridFS.html">The GridFS plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GlusterFS.html">The GlusterFS plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Rados.html">The RADOS plugin</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Pty.html">The Pty plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SPNEGO.html">SPNEGO authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LDAP.html">Configuring uWSGI with LDAP</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Erlang.html">Integrating uWSGI with Erlang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ManagementFlag.html">Management Flags</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Go.html">uWSGI Go support (1.4 only)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.18.html">uWSGI 2.0.18</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.17.1.html">uWSGI 2.0.17.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.17.html">uWSGI 2.0.17</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.16.html">uWSGI 2.0.16</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.15.html">uWSGI 2.0.15</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.14.html">uWSGI 2.0.14</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.13.1.html">uWSGI 2.0.13.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.13.html">uWSGI 2.0.13</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.12.html">uWSGI 2.0.12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.11.2.html">uWSGI 2.0.11.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.11.1.html">uWSGI 2.0.11.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.11.html">uWSGI 2.0.11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.10.html">uWSGI 2.0.10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.9.html">uWSGI 2.0.9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.8.html">uWSGI 2.0.8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.7.html">uWSGI 2.0.7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.6.html">uWSGI 2.0.6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.5.html">uWSGI 2.0.5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.4.html">uWSGI 2.0.4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.3.html">uWSGI 2.0.3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.2.html">uWSGI 2.0.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.1.html">uWSGI 2.0.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-2.0.html">uWSGI 2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.21.html">uWSGI 1.9.21</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.20.html">uWSGI 1.9.20</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.19.html">uWSGI 1.9.19</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.18.html">uWSGI 1.9.18</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.17.html">uWSGI 1.9.17</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.16.html">uWSGI 1.9.16</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.15.html">uWSGI 1.9.15</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.14.html">uWSGI 1.9.14</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.13.html">uWSGI 1.9.13</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.12.html">uWSGI 1.9.12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.11.html">uWSGI 1.9.11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.10.html">uWSGI 1.9.10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.9.html">uWSGI 1.9.9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.8.html">uWSGI 1.9.8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.7.html">uWSGI 1.9.7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.6.html">uWSGI 1.9.6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.5.html">uWSGI 1.9.5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.4.html">uWSGI 1.9.4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.3.html">uWSGI 1.9.3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.2.html">uWSGI 1.9.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.1.html">uWSGI 1.9.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Changelog-1.9.html">uWSGI 1.9</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">uWSGI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Offloading Websockets and Server-Sent Events AKA &quot;Combine them with Django safely&quot;</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/articles/OffloadingWebsocketsAndSSE.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="offloading-websockets-and-server-sent-events-aka-combine-them-with-django-safely">
<h1>Offloading Websockets and Server-Sent Events AKA &quot;Combine them with Django safely&quot;<a class="headerlink" href="#offloading-websockets-and-server-sent-events-aka-combine-them-with-django-safely" title="제목 주소">¶</a></h1>
<p>Author: Roberto De Ioris</p>
<p>Date: 20140315</p>
<div class="section" id="disclaimer">
<h2>Disclaimer<a class="headerlink" href="#disclaimer" title="제목 주소">¶</a></h2>
<p>This article shows a pretty advanced way for combining websockets (or sse) apps with Django in a &quot;safe way&quot;. It will not show you
how cool websockets and sse are, or how to write better apps with them, it is an attempt to try to avoid bad practices with them.</p>
<p>In my opinion the Python web-oriented world is facing a communication/marketing problem: There is a huge number of people
running heavily blocking apps (like Django) on non-blocking technologies (like gevent) only because someone told them it is cool and will solve all of their scaling issues.</p>
<p>This is completely WRONG, DANGEROUS and EVIL, you cannot mix blocking apps with non-blocking engines, even a single, ultra-tiny blocking part
can potentially destroy your whole stack. As I have already said dozens of time, if your app is 99.9999999% non-blocking, it is still blocking.</p>
<p>And no, monkey-patching on your Django app is not magic. Unless you are using pretty-customized database adapters, tuned for working in a non-blocking way, you are doing it wrong.</p>
<p>At the cost of looking a huber-asshole, I strongly suggest you completely ignore people suggesting you move your Django app to gevent, eventlet, tornado or whatever, without warning you about
the hundreds of problems you may encounter.</p>
<p>Having said that, I love gevent, it is probably the best (with perl's Coro::AnyEvent) supported loop engine in the uWSGI project. So in this article I will use gevent for managing websocket/sse traffic and plain multiprocessing for the Django part.</p>
<p>If this last sentence looks like nonsense to you, you probably do not know what uWSGI offloading is...</p>
</div>
<div class="section" id="uwsgi-offloading">
<h2>uWSGI offloading<a class="headerlink" href="#uwsgi-offloading" title="제목 주소">¶</a></h2>
<p>The concept is not a new thing, or a uWSGI specific one. Projects like nodejs or twisted have used it for ages.</p>
<div class="admonition note">
<p class="first admonition-title">주석</p>
<p class="last">an example of a webapp serving a static file is not very interesting, nor the best thing to show, but will be useful later, when presenting a real-world scenario with X-Sendfile</p>
</div>
<p>Immagine this simple WSGI app:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)])</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/etc/services&#39;</span><span class="p">)</span>
    <span class="c1"># do not do it, if the file is 4GB it will allocate 4GB of memory !!!</span>
    <span class="k">yield</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>This will simply return the content of /etc/services. It is a pretty tiny file, so in few milliseconds your process will be ready to process another request.</p>
<p>What if /etc/services is 4 gigabytes? Your process (or thread) will be blocked for several seconds (even minutes), and will not be able to manage another request
until the file is completely transferred.</p>
<p>Wouldn't it be cool if you could tell another thread to send the file for you, so you will be able to manage another request?</p>
<p>Offloading is exactly this: it will give you one ore more threads for doing simple and slow task for you. Which kind of tasks? All of those that can be managed
in a non-blocking way, so a single thread can manage thousand of transfers for you.</p>
<p>You can see it as the DMA engine in your computer, your CPU will program the DMA to transfer memory from a controller to the RAM, and then will be freed to accomplish another task while the DMA works in background.</p>
<p>To enable offloading in uWSGI you only need to add the <code class="docutils literal notranslate"><span class="pre">--offload-threads</span> <span class="pre">&lt;n&gt;</span></code> option, where &lt;n&gt; is the number of threads per-process to spawn. (generally a single thread will be more than enough, but if you want to use/abuse your multiple cpu cores feel free to increase it)</p>
<p>Once offloading is enabled, uWSGI will automatically use it whenever it detects that an operation can be offloaded safely.</p>
<p>In the python/WSGI case any use of wsgi.file_wrapper will be offloaded automatically, as well as when you use the uWSGI proxy features for passing requests to other server speaking the uwsgi or HTTP protocol.</p>
<p>A cool example (showed even in the Snippets page of uWSGI docs) is implementing an offload-powered X-Sendfile feature:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; load router_static plugin (compiled in by default in monolithic profiles)</span>
<span class="na">plugins</span> <span class="o">=</span> <span class="s">router_static</span>

<span class="c1">; spawn 2 offload threads</span>
<span class="na">offload-threads</span> <span class="o">=</span> <span class="s">2</span>

<span class="c1">; files under /etc can be safely served (DANGEROUS !!!)</span>
<span class="na">static-safe</span> <span class="o">=</span> <span class="s">/etc</span>

<span class="c1">; collect the X-Sendfile response header as X_SENDFILE var</span>
<span class="na">collect-header</span> <span class="o">=</span> <span class="s">X-Sendfile X_SENDFILE</span>

<span class="c1">; if X_SENDFILE is not empty, pass its value to the &quot;static&quot; routing action (it will automatically use offloading if available)</span>
<span class="na">response-route-if-not</span> <span class="o">=</span> <span class="s">empty:${X_SENDFILE} static:${X_SENDFILE}</span>

<span class="c1">; now the classic options</span>
<span class="na">plugins</span> <span class="o">=</span> <span class="s">python</span>
<span class="c1">; bind to HTTP port 8080</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:8080</span>
<span class="c1">; load a simple wsgi-app</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">myapp.py</span>
</pre></div>
</div>
<p>Now in our app we can X-Sendfile to send static files without blocking:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,[(</span><span class="s1">&#39;X-Sendfile&#39;</span><span class="p">,</span><span class="s1">&#39;/etc/services&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[]</span>
</pre></div>
</div>
<p>A very similar concept will be used in this article: We will use a normal Django to setup our session, to authorize the user and whatever (that is fast) you want, then we will return a special header that will instruct uWSGI to offload the connection to another uWSGI instance (listening on a private socket) that will manage the websocket/sse transaction using gevent in a non-blocking way.</p>
</div>
<div class="section" id="our-sse-app">
<h2>Our SSE app<a class="headerlink" href="#our-sse-app" title="제목 주소">¶</a></h2>
<p>The SSE part will be very simple, a gevent-based WSGI app will send the current time every second:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sse</span> <span class="kn">import</span> <span class="n">Sse</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">e</span>
    <span class="c1"># create the SSE session</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Sse</span><span class="p">()</span>
    <span class="c1"># prepare HTTP headers</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span><span class="s1">&#39;text/event-stream&#39;</span><span class="p">))</span>
    <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">,</span><span class="s1">&#39;no-cache&#39;</span><span class="p">))</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="c1"># enter the loop</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1"># monkey patching will prevent sleep() blocking</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># add the message</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="c1"># send to the client</span>
        <span class="k">yield</span> <span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</pre></div>
</div>
<p>Let's run it on /tmp/foo UNIX socket (save the app as sseapp.py)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --wsgi-file sseapp.py --socket /tmp/foo --gevent <span class="m">1000</span> --gevent-monkey-patch
</pre></div>
</div>
<p>(monkey patching is required for time.sleep(), feel free to use gevent primitives for sleeping if you want/prefer)</p>
</div>
<div class="section" id="the-boring-html-javascript">
<h2>The (boring) HTML/Javascript<a class="headerlink" href="#the-boring-html-javascript" title="제목 주소">¶</a></h2>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Server sent events<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;event&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;</span>

      <span class="kd">var</span> <span class="nx">eventOutputContainer</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">evtSrc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventSource</span><span class="p">(</span><span class="s2">&quot;/subscribe&quot;</span><span class="p">);</span>

      <span class="nx">evtSrc</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
          <span class="nx">eventOutputContainer</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
      <span class="p">};</span>

      <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>It is very simple, it will connect to /subscribe and will start waiting for events.</p>
</div>
<div class="section" id="the-django-view">
<h2>The Django view<a class="headerlink" href="#the-django-view" title="제목 주소">¶</a></h2>
<p>Our django view, will be very simple, it will simply generate a special response header (we will call it X-Offload-to-SSE) with the username of the logged user as its value:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">()</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">&#39;X-Offload-to-SSE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
<p>Now we are ready for the &quot;advanced&quot; part.</p>
</div>
<div class="section" id="let-s-offload-the-sse-transaction">
<h2>Let's offload the SSE transaction<a class="headerlink" href="#let-s-offload-the-sse-transaction" title="제목 주소">¶</a></h2>
<p>The configuration could look a bit complex but it is the same concept of the X-Sendfile seen before:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; the boring part</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="na">offload-threads</span> <span class="o">=</span> <span class="s">2</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">sseproject/wsgi.py</span>

<span class="c1">; collect X-Offload-to-SSE header and store in var X_OFFLOAD</span>
<span class="na">collect-header</span> <span class="o">=</span> <span class="s">X-Offload-to-SSE X_OFFLOAD</span>
<span class="c1">; if X_OFFLOAD is defined, do not send the headers generated by Django</span>
<span class="na">response-route-if-not</span> <span class="o">=</span> <span class="s">empty:${X_OFFLOAD} disableheaders:</span>
<span class="c1">; if X_OFFLOAD is defined, offload the request to the app running on /tmp/foo</span>
<span class="na">response-route-if-not</span> <span class="o">=</span> <span class="s">empty:${X_OFFLOAD} uwsgi:/tmp/foo,0,0</span>
</pre></div>
</div>
<p>The only &quot;new' part is the use of <code class="docutils literal notranslate"><span class="pre">disableheaders</span></code> routing action. It is required otherwise the headers generated by Django
will be sent along the ones generated by the gevent-based app.</p>
<p>You could avoid it (remember that <code class="docutils literal notranslate"><span class="pre">disableheaders</span></code> has been added only in 2.0.3) removing the call to start_response() in the gevent app (at the risk of being cursed by some WSGI-god) and changing the Django view
to set the right headers:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">()</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;text/event-stream&#39;</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">&#39;X-Offload-to-SSE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
<p>Eventually you may want to be more &quot;streamlined&quot; and simply detect for 'text/event-stream' content_type presence:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; the boring part</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="na">offload-threads</span> <span class="o">=</span> <span class="s">2</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">sseproject/wsgi.py</span>

<span class="c1">; collect Content-Type header and store in var CONTENT_TYPE</span>
<span class="na">collect-header</span> <span class="o">=</span> <span class="s">Content-Type CONTENT_TYPE</span>
<span class="c1">; if CONTENT_TYPE is &#39;text/event-stream&#39;, forward the request</span>
<span class="na">response-route-if</span> <span class="o">=</span> <span class="s">equal:${CONTENT_TYPE};text/event-stream uwsgi:/tmp/foo,0,0</span>
</pre></div>
</div>
<p>Now, how to access the username of the Django-logged user in the gevent app?</p>
<p>You should have noted that the gevent-app prints the content of the WSGI environ on each request. That environment is the same
of the Django app + the collected headers. So accessing environ['X_OFFLOAD'] will return the logged username. (obviously in the second example, where the content type is used, the variable with the username is no longer collected, so you should fix it)</p>
<p>You can pass all of the information you need using the same approach, you can collect all of the vars you need and so on.</p>
<p>You can even add variables at runtime:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; the boring part</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="na">offload-threads</span> <span class="o">=</span> <span class="s">2</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">sseproject/wsgi.py</span>

<span class="c1">; collect Content-Type header and store in var CONTENT_TYPE</span>
<span class="na">collect-header</span> <span class="o">=</span> <span class="s">Content-Type CONTENT_TYPE</span>

<span class="na">response-route-if</span> <span class="o">=</span> <span class="s">equal:${CONTENT_TYPE};text/event-stream addvar:FOO=BAR</span>
<span class="na">response-route-if</span> <span class="o">=</span> <span class="s">equal:${CONTENT_TYPE};text/event-stream addvar:TEST1=TEST2</span>

<span class="c1">; if CONTENT_TYPE is &#39;text/event-stream&#39;, forward the request</span>
<span class="na">response-route-if</span> <span class="o">=</span> <span class="s">equal:${CONTENT_TYPE};text/event-stream uwsgi:/tmp/foo,0,0</span>
</pre></div>
</div>
<p>Or (using goto for better readability):</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; the boring part</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="na">offload-threads</span> <span class="o">=</span> <span class="s">2</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">sseproject/wsgi.py</span>

<span class="c1">; collect Content-Type header and store in var CONTENT_TYPE</span>
<span class="na">collect-header</span> <span class="o">=</span> <span class="s">Content-Type CONTENT_TYPE</span>

<span class="na">response-route-if</span> <span class="o">=</span> <span class="s">equal:${CONTENT_TYPE};text/event-stream goto:offload</span>
<span class="na">response-route-run</span> <span class="o">=</span> <span class="s">last:</span>

<span class="na">response-route-label</span> <span class="o">=</span> <span class="s">offload</span>
<span class="na">response-route-run</span> <span class="o">=</span> <span class="s">addvar:FOO=BAR</span>
<span class="na">response-route-run</span> <span class="o">=</span> <span class="s">addvar:TEST1=TEST2</span>
<span class="na">response-route-run</span> <span class="o">=</span> <span class="s">uwsgi:/tmp/foo,0,0</span>
</pre></div>
</div>
</div>
<div class="section" id="simplifying-things-using-the-uwsgi-api-uwsgi-2-0-3">
<h2>Simplifying things using the uwsgi api (&gt;= uWSGI 2.0.3)<a class="headerlink" href="#simplifying-things-using-the-uwsgi-api-uwsgi-2-0-3" title="제목 주소">¶</a></h2>
<p>While dealing with headers is pretty HTTP friendly, uWSGI 2.0.3 added the possibility to define per-request variables
directly in your code.</p>
<p>This allows a more &quot;elegant&quot; approach (even if highly non-portable):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uwsgi</span>

<span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">uwsgi</span><span class="o">.</span><span class="n">add_var</span><span class="p">(</span><span class="s2">&quot;LOGGED_IN_USER&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">uwsgi</span><span class="o">.</span><span class="n">add_var</span><span class="p">(</span><span class="s2">&quot;USER_IS_UGLY&quot;</span><span class="p">,</span> <span class="s2">&quot;probably&quot;</span><span class="p">)</span>
    <span class="n">uwsgi</span><span class="o">.</span><span class="n">add_var</span><span class="p">(</span><span class="s2">&quot;OFFLOAD_TO_SSE&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
    <span class="n">uwsgi</span><span class="o">.</span><span class="n">add_var</span><span class="p">(</span><span class="s2">&quot;OFFLOAD_SERVER&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/foo&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">()</span>
</pre></div>
</div>
<p>Now the config can change to something more gentle:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">; the boring part</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="na">offload-threads</span> <span class="o">=</span> <span class="s">2</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">sseproject/wsgi.py</span>

<span class="c1">; if OFFLOAD_TO_SSE is &#39;y&#39;, do not send the headers generated by Django</span>
<span class="na">response-route-if</span> <span class="o">=</span> <span class="s">equal:${OFFLOAD_TO_SSE};y disableheaders:</span>
<span class="c1">; if OFFLOAD_TO_SSE is &#39;y&#39;, offload the request to the app running on &#39;OFFLOAD_SERVER&#39;</span>
<span class="na">response-route-if</span> <span class="o">=</span> <span class="s">equal:${OFFLOAD_TO_SSE};y uwsgi:${OFFLOAD_SERVER},0,0</span>
</pre></div>
</div>
<p>Have you noted how we allowed the Django app to set the backend server to use using a request variable?</p>
<p>Now we can go even further. We will not use the routing framework (except for disabling headers generation):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uwsgi</span>

<span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">uwsgi</span><span class="o">.</span><span class="n">add_var</span><span class="p">(</span><span class="s2">&quot;LOGGED_IN_USER&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">uwsgi</span><span class="o">.</span><span class="n">add_var</span><span class="p">(</span><span class="s2">&quot;USER_IS_UGLY&quot;</span><span class="p">,</span> <span class="s2">&quot;probably&quot;</span><span class="p">)</span>
    <span class="n">uwsgi</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;uwsgi&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/foo,0,0&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">()</span>
</pre></div>
</div>
<p>and a simple:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">; the boring part</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="na">offload-threads</span> <span class="o">=</span> <span class="s">2</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">sseproject/wsgi.py</span>

<span class="na">response-route</span> <span class="o">=</span> <span class="s">^/subscribe disableheaders:</span>
</pre></div>
</div>
</div>
<div class="section" id="what-about-websockets">
<h2>What about Websockets ?<a class="headerlink" href="#what-about-websockets" title="제목 주소">¶</a></h2>
<p>We have seen how to offload SSE (that are mono-directional). We can offload websockets too (that are bidirectional).</p>
<p>The concept is the same, you only need to ensure (as before) that no headers are sent by django, (otherwise the websocket handshake will fail) and then you
can change your gevent app:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uwsgi</span>

<span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">e</span>
    <span class="n">uwsgi</span><span class="o">.</span><span class="n">websocket_handshake</span><span class="p">()</span>
    <span class="c1"># enter the loop</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1"># monkey patching will prevent sleep() to block</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># send to the client</span>
        <span class="n">uwsgi</span><span class="o">.</span><span class="n">websocket_send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="section" id="using-redis-or-uwsgi-caching-framework">
<h2>Using redis or uWSGI caching framework<a class="headerlink" href="#using-redis-or-uwsgi-caching-framework" title="제목 주소">¶</a></h2>
<p>Request vars are handy (and funny), but they are limited (see below). If you need to pass a big amount of data between Django and the sse/websocket app, Redis
is a great way (and works perfectly with gevent). Basically you store infos from django to redis and than you pass only the hash key (via request vars) to the sse/websocket app.</p>
<p>The same can be accomplished with the uWSGI caching framework, but take into account redis has a lot of data primitives, while uWSGI only supports key-&gt;value items.</p>
</div>
<div class="section" id="common-pitfalls">
<h2>Common pitfalls<a class="headerlink" href="#common-pitfalls" title="제목 주소">¶</a></h2>
<ul class="simple">
<li>The amount of variables you can add per-request is limited by the uwsgi packet buffer (default 4k). You can increase it up to 64k with the --buffer-size option.</li>
<li>This is the whole point of this article: do not use the Django ORM in your gevent apps unless you know what you are doing!!! (read: you have a django database adapter that supports gevent and does not suck compared to the standard ones...)</li>
<li>Forget about finding a way to disable headers generation in django. This is a &quot;limit/feature&quot; of its WSGI adapter, use the uWSGI facilities (if available) or do not generate headers in your gevent app. Eventually you can modify wsgi.py in this way:</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">WSGI config for sseproject project.</span>

<span class="sd">It exposes the WSGI callable as a module-level variable named ``application``.</span>

<span class="sd">For more information on this file, see</span>
<span class="sd">https://docs.djangoproject.com/en/1.6/howto/deployment/wsgi/</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span class="p">,</span> <span class="s2">&quot;sseproject.settings&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">django.core.wsgi</span> <span class="kn">import</span> <span class="n">get_wsgi_application</span>
<span class="n">django_application</span> <span class="o">=</span> <span class="n">get_wsgi_application</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">fake_start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/subscribe&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">django_application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">fake_start_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">django_application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="WSGIEnvBehaviour.html" class="btn btn-neutral float-right" title="WSGI env behaviour policies" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="FunWithPerlEyetoyRaspberrypi.html" class="btn btn-neutral" title="Fun with Perl, Eyetoy and RaspberryPi" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2012-2016, uWSGI.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'2.0',
            LANGUAGE:'ko',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>